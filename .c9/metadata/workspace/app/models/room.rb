{"changed":true,"filter":false,"title":"room.rb","tooltip":"/app/models/room.rb","value":"class Room < ActiveRecord::Base\n  belongs_to :area\n  has_many :rxdescs, dependent: :destroy\n  has_many :exits, dependent: :destroy\n  has_many :room_specials, dependent: :destroy\n  has_many :triggers, through: :exits, :source => :triggers\n  \n  include Bitfields\n  bitfield :room_flags, \n                2**0 =>  :dark,          # Dec:          1 / Hex:         1\n                2**1 =>  :no_sleep,      # Dec:          2 / Hex:         2\n                2**2 =>  :no_mob,        # Dec:          4 / Hex:         4\n                2**3 =>  :indoors,       # Dec:          8 / Hex:         8\n#               2**4 =>  :flag,          # Dec:         16 / Hex:        10\n                2**5 =>  :foggy,         # Dec:         32 / Hex:        20\n                2**6 =>  :fire,          # Dec:         64 / Hex:        40\n                2**7 =>  :lava,          # Dec:        128 / Hex:        80\n#               2**8 =>  :flag,          # Dec:        256 / Hex:       100\n                2**9 =>  :private_room,  # Dec:        512 / Hex:       200\n                2**10 => :peaceful,      # Dec:       1024 / Hex:       400\n                2**11 => :solitary,      # Dec:       2048 / Hex:       800\n#               2**12 => :flag,          # Dec:       4096 / Hex:      1000\n                2**13 => :no_recall,     # Dec:       8192 / Hex:      2000\n                2**14 => :no_steal,      # Dec:      16384 / Hex:      4000\n                2**15 => :notrans,       # Dec:      32768 / Hex:      8000\n                2**16 => :no_spell,      # Dec:      65536 / Hex:     10000\n                2**17 => :seafloor,      # Dec:     131072 / Hex:     20000\n                2**18 => :no_fly,        # Dec:     262144 / Hex:     40000\n                2**19 => :holy_ground,   # Dec:     524288 / Hex:     80000\n                2**20 => :fly_ok,        # Dec:    1048576 / Hex:    100000\n                2**21 => :no_quest,      # Dec:    2097152 / Hex:    200000\n                2**22 => :no_item,       # Dec:    4194304 / Hex:    400000\n                2**23 => :no_vnum        # Dec:    8388608 / Hex:    800000\n#               2**24 => :flag,          # Dec:   16777216 / Hex:   1000000\n#               2**25 => :flag,          # Dec:   33554432 / Hex:   2000000\n#               2**26 => :flag,          # Dec:   67108864 / Hex:   4000000\n#               2**27 => :flag,          # Dec:  134217728 / Hex:   8000000\n#               2**28 => :flag,          # Dec:  268435456 / Hex:  10000000\n#               2**29 => :flag,          # Dec:  536870912 / Hex:  20000000\n#               2**30 => :flag,          # Dec: 1073741824 / Hex:  40000000\n#               2**31 => :flag,          # Dec: 2147483648 / Hex:  80000000\n#               2**32 => :flag,          # Dec: 4294967296 / Hex: 100000000\n\n  validates :vnum, :numericality => { only_integer: true,\n                                   greater_than_or_equal_to: 0,\n                                   :less_than => :max_vnum,\n                                   message: \"Can't exceed max allowable vnum.\"\n                                  },\n                   uniqueness:   { scope: :area,\n                                   message: \"No duplicate vnums allowed.\" }\n    \n  validates :name, length: { in: 4..75 }, format: { with: /\\A[ -~]+\\z/, message: \"Only US-ASCII characters are permitted.\" }\n  validates :description, length: { minimum: 4 }, format: { with: /\\A[\\x0A\\x0D -~]+\\z/, message: \"Only US-ASCII characters are permitted.\" }\n  validates :terrain, numericality: { only_integer: true, greater_than_or_equal_to: 0 }\n\n  before_create :default_values\n  def default_values\n    self.room_flags ||= 0\n    self.terrain ||= 0\n  end\n\n  def max_vnum\n    area.vnum_qty\n  end\n  \n  def formal_vnum\n    (area.area_number * 100) + self.vnum\n  end\n  \n  def next_room\n    $next_room = false # return self if no next room\n    x = self.vnum + 1\n    for i in x..self.area.vnum_qty\n      if self.area.rooms.exists?(:vnum => i)\n        $next_room = self.area.rooms.where(:vnum => i).first\n        break\n      end\n    end\n    return $next_room\n  end\n  \n  def last_room\n    $last_room = false # return self if no last room\n    i = self.vnum\n    until i < 0\n      i -= 1\n      if self.area.rooms.exists?(:vnum => i)\n        $last_room = self.area.rooms.where(:vnum => i).first\n        break\n      end\n    end\n    return $last_room\n  end\n\n  def any_bad_exits?\n    $result = false\n    self.exits.each do |exit|\n      if exit.is_bad?\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def any_external_exits?\n    $result = false\n    self.exits.each do |exit|\n      if exit.is_external?\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def any_illogical_exits?\n    $result = false\n    self.exits.each do |exit|\n      if exit.is_illogical?\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def any_loopback_exits?\n    $result = false\n    self.exits.each do |exit|\n      if exit.is_loopback?\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def any_oneway_exits?\n    $result = false\n    self.exits.each do |exit|\n      if exit.is_one_way?\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def any_door_mismatches?\n    $result = false\n    self.exits.each do |exit|\n      if exit.reciprocal_door_mismatch?\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def exit_dir_exists?(i)\n    $result = false\n    self.exits.each do |exit|\n      if exit.direction == i\n        $result = true\n      end\n    end\n    return $result\n  end\n  \n  def vnum_and_name\n    return  format(\"%03d\",self.vnum) + \" \" + self.name\n  end\n  \n  def terrain_word\n    $result = 'INSIDE'\n    $result = 'CITY' if self.terrain == 1\n    $result = 'FIELD' if self.terrain == 2\n    $result = 'FOREST' if self.terrain == 3\n    $result = 'HILLS' if self.terrain == 4\n    $result = 'MOUNTAIN' if self.terrain == 5\n    $result = 'WATER SWIM' if self.terrain == 6\n    $result = 'WATER NOSWIM' if self.terrain == 7\n    $result = 'UNDERWATER' if self.terrain == 8\n    $result = 'AIR' if self.terrain == 9\n    $result = 'DESERT' if self.terrain == 10\n    return $result\n  end\n\n  def room_flags_as_string\n    $flags_string = ''\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }DARK\" if self.dark\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_SLEEP\" if self.no_sleep\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_MOB\" if self.no_mob\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }INDOORS\" if self.indoors\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }FOGGY\" if self.foggy\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }FIRE\" if self.fire\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }PRIVATE\" if self.private_room\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }PEACEFUL\" if self.peaceful\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }SOLITARY\" if self.solitary\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_RECALL\" if self.no_recall\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_STEAL\" if self.no_steal\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_TRANS\" if self.notrans\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_SPELL\" if self.no_spell\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }SEAFLOOR\" if self.seafloor\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_FLY\" if self.no_fly\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }HOLY_GROUND\" if self.holy_ground\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }FLY_OK\" if self.fly_ok\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_QUEST\" if self.no_quest\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_ITEM\" if self.no_item\n    $flags_string = \"#{$flags_string}#{' ' if $flags_string.length > 0 }NO_VNUM\" if self.no_vnum\n    return $flags_string\n  end\n  \n  def has_contents?\n    if self.area.resets.where(reset_type: ['M', 'Q', 'O']).where(val_4: self.id).count > 0\n      return true\n    else\n      return false\n    end\n  end\n\nend","undoManager":{"mark":79,"position":80,"stack":[[{"group":"doc","deltas":[{"start":{"row":55,"column":40},"end":{"row":55,"column":41},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":41},"end":{"row":56,"column":36},"action":"insert","lines":[", format: { with: /\\A[a-zA-Z]+\\z/,","    message: \"only allows letters\" }"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":41},"end":{"row":55,"column":42},"action":"remove","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":74},"end":{"row":56,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":74},"end":{"row":55,"column":76},"action":"remove","lines":["  "]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":74},"end":{"row":55,"column":76},"action":"remove","lines":["  "]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":74},"end":{"row":55,"column":75},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":85},"end":{"row":55,"column":104},"action":"remove","lines":["only allows letters"]},{"start":{"row":55,"column":85},"end":{"row":55,"column":86},"action":"insert","lines":["A"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":86},"end":{"row":55,"column":87},"action":"insert","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":86},"end":{"row":55,"column":87},"action":"remove","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":85},"end":{"row":55,"column":86},"action":"remove","lines":["A"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":85},"end":{"row":55,"column":86},"action":"insert","lines":["U"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":86},"end":{"row":55,"column":87},"action":"insert","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":87},"end":{"row":55,"column":88},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":88},"end":{"row":55,"column":89},"action":"insert","lines":["A"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":89},"end":{"row":55,"column":90},"action":"insert","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":88},"end":{"row":55,"column":90},"action":"remove","lines":["AS"]},{"start":{"row":55,"column":88},"end":{"row":55,"column":93},"action":"insert","lines":["ASCII"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":93},"end":{"row":55,"column":94},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":94},"end":{"row":55,"column":95},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":95},"end":{"row":55,"column":96},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":96},"end":{"row":55,"column":97},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":97},"end":{"row":55,"column":98},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":98},"end":{"row":55,"column":99},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":99},"end":{"row":55,"column":100},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":100},"end":{"row":55,"column":101},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":101},"end":{"row":55,"column":102},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":102},"end":{"row":55,"column":103},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":103},"end":{"row":55,"column":104},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":104},"end":{"row":55,"column":105},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":105},"end":{"row":55,"column":106},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":105},"end":{"row":55,"column":106},"action":"remove","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":105},"end":{"row":55,"column":106},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":106},"end":{"row":55,"column":107},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":107},"end":{"row":55,"column":108},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":108},"end":{"row":55,"column":109},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":109},"end":{"row":55,"column":110},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":59},"end":{"row":55,"column":72},"action":"remove","lines":["\\A[a-zA-Z]+\\z"]},{"start":{"row":55,"column":59},"end":{"row":55,"column":64},"action":"insert","lines":["[ -~]"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":64},"end":{"row":55,"column":65},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":64},"end":{"row":55,"column":65},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":56,"column":48},"end":{"row":56,"column":113},"action":"insert","lines":[", format: { with: /[ -~]/, message: \"US-ASCII characters only.\" }"]}]}],[{"group":"doc","deltas":[{"start":{"row":56,"column":113},"end":{"row":56,"column":114},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":56,"column":113},"end":{"row":56,"column":114},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":56,"column":72},"end":{"row":56,"column":73},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":55,"column":64},"end":{"row":55,"column":65},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":0},"end":{"row":53,"column":0},"action":"remove","lines":["# validates :baggage, :numericality => { :less_than => :max_vnum }, :presence => true ","",""]},{"start":{"row":51,"column":0},"end":{"row":51,"column":1},"action":"insert","lines":["\\"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":0},"end":{"row":51,"column":1},"action":"remove","lines":["\\"]}]}],[{"group":"doc","deltas":[{"start":{"row":50,"column":0},"end":{"row":51,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":75},"end":{"row":50,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":58},"end":{"row":51,"column":66},"action":"remove","lines":["/[ -~]+/"]},{"start":{"row":51,"column":58},"end":{"row":51,"column":73},"action":"insert","lines":["/\\A[a-zA-Z]+\\z/"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":62},"end":{"row":51,"column":68},"action":"remove","lines":["a-zA-Z"]},{"start":{"row":51,"column":62},"end":{"row":51,"column":63},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":63},"end":{"row":51,"column":64},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":64},"end":{"row":51,"column":65},"action":"insert","lines":["~"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":66},"end":{"row":52,"column":74},"action":"remove","lines":["/[ -~]+/"]},{"start":{"row":52,"column":66},"end":{"row":52,"column":78},"action":"insert","lines":["/\\A[ -~]+\\z/"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":82},"end":{"row":51,"column":83},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":83},"end":{"row":51,"column":84},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":84},"end":{"row":51,"column":85},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":85},"end":{"row":51,"column":86},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":86},"end":{"row":51,"column":87},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":107},"end":{"row":51,"column":108},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":108},"end":{"row":51,"column":109},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":109},"end":{"row":51,"column":110},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":110},"end":{"row":51,"column":111},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":110},"end":{"row":51,"column":111},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":110},"end":{"row":51,"column":111},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":111},"end":{"row":51,"column":112},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":112},"end":{"row":51,"column":113},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":113},"end":{"row":51,"column":114},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":114},"end":{"row":51,"column":115},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":115},"end":{"row":51,"column":116},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":116},"end":{"row":51,"column":117},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":117},"end":{"row":51,"column":118},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":118},"end":{"row":51,"column":119},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":119},"end":{"row":51,"column":120},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":120},"end":{"row":51,"column":121},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":120},"end":{"row":51,"column":121},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":120},"end":{"row":51,"column":121},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":120},"end":{"row":51,"column":121},"action":"remove","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":82},"end":{"row":51,"column":83},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":51,"column":82},"end":{"row":51,"column":83},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":90},"end":{"row":52,"column":114},"action":"remove","lines":["US-ASCII characters only"]},{"start":{"row":52,"column":90},"end":{"row":52,"column":128},"action":"insert","lines":["Only US-ASCII characters are permitted"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":70},"end":{"row":52,"column":78},"action":"insert","lines":["\\x0A\\x0D"]}]}]]},"ace":{"folds":[],"scrolltop":454.5,"scrollleft":0,"selection":{"start":{"row":52,"column":78},"end":{"row":52,"column":78},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":31,"state":"start","mode":"ace/mode/ruby"}},"timestamp":1425187878358}